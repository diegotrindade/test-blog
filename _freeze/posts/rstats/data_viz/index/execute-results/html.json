{
  "hash": "cee750758f1c783aa4c997948be29d9b",
  "result": {
    "markdown": "---\ntitle: \"#2 Data visualization with `ggplot2`\"\nauthor: Diego P.F. Trindade\ndate: '2020-07-15'\nslug: data-visualization-in-ecology\nhtml:\n    fig-width: 8\n    fig-height: 8\nexecute:\n  echo: true\n  warning: false\n  message: false\ncategories: []\ntags:\n  - ggplot\n  - ecology\n  - tidyverse\n  - data visualization\nimage:\n  \"featured.png\"\n---\n\n\n![Image credit: Alisson Horst](featured.png)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#| eval=false\n\n\n#install.packages(c(\"here\", \"dplyr\", \"vroom\", \"tidyr\", \"purrr\")) #1 post\n#install.packages(c(\"ggplot2\", \"cowplot\", \"glue\", \"ggtext\", \"ggrepel\")) #2 post\n\nlibrary(here)\nlibrary(dplyr)\nlibrary(vroom)\nlibrary(tidyr)\nlibrary(purrr)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(ggrepel)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#| include=false\n\n\nlibrary(here)\nlibrary(dplyr)\nlibrary(vroom)\nlibrary(tidyr)\nlibrary(purrr)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(ggtext)\nlibrary(ggrepel)\nlibrary(tidyverse)\nlibrary(maps)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#| include=false\n#| \n#devtools::install_dev(\"vroom\")\nlibrary(vroom)\n\nbiotime_df <- vroom(here(\"posts\", \"rstats\", \n                         \"biotime.zip\"), delim = \",\")\n\nbiotime_metadata <- vroom(here(\"posts\", \"rstats\",\n                               \"biotime_meta.csv\"), delim = \",\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#| include=false\n#| \nbiotime <- biotime_df %>% \n  select(id = STUDY_ID, year = YEAR, plot = PLOT, \n         abundance = sum.allrawdata.ABUNDANCE, \n         biomass = sum.allrawdata.BIOMASS, sp = GENUS_SPECIES, LONGITUDE, LATITUDE)\n\n\nmetadata <- biotime_metadata %>% \n  select(STUDY_ID:ORGANISMS) %>% \n  rename(id = STUDY_ID)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#| include=false\n\n\nmerge_df <- left_join(biotime, metadata, by = \"id\")\n```\n:::\n\n\n# Data visualization with `ggplot2`\n\nBesides being able to clean and explore data in ecology, it is also important to know how to visualize and present the patterns you found. Here I'm gonna show very briefly how to create histograms, bar plots, box plots and scatter plots with `ggplot2`. Further, I'm going through how to combine different plots using `cowplot`. I will try to use the knowledge we gathered in our previous post, i.e. using `dplyr` and `purrr` functions.\n\nWe can use the data we joined last time (`merge_df`) to start making some graphs.\n\nIn ggplot we start the figure with the function `ggplot()` and then use `aes(x,y)` to tell the function the variables we want to plot. Afterwards, we can add several arguments to our plot using `+`, which is something similar to `%>%` in `dplyr`.\n\n## Histograms\n\nLet's start by a simple histogram, checking the distribution of years of sampling among studies.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n merge_df %>% \n  group_by(id) %>% \n  summarise(n_year=n_distinct(year)) %>%\n  ungroup %>%\n  ggplot(aes(x=n_year))+\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nAlthough we can see the distribution of years, this plot can be improved. So, let's change the x axis, specifying the breaks we want, put some colour (red), modify the opacity (with `alpha`), and change axis' title (with `labs()`).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyear_histplot <-merge_df %>% \n  group_by(id) %>% \n  summarise(n_year=n_distinct(year)) %>%\n  ungroup %>%\n  ggplot(aes(x=n_year))+\n  geom_histogram(bins=50,fill = \"red\", alpha=.5)+\n  scale_x_continuous(breaks = seq(2, 100, by = 5))+\n  labs(x=\"Years of sampling\", y=\"Number of studies\")\n\nyear_histplot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nOk.. so now we can see that most studies range from 5-15 years of sampling, and we have two studies with very long term sampling (88 and 97 years, respectively)\n\n## Barplots\n\nNow let's check the number of studies per taxa and climate, using `geom_col()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmerge_df %>% \n  group_by(TAXA) %>% \n  summarise(n_studies=n_distinct(id)) %>%\n  ungroup %>%\n  ggplot(aes(x=TAXA, y=n_studies))+\n  geom_col()+\n  labs(x=\"\", y=\"Number of studies\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nNow I will\n\n-   add a legend with different colors based on taxa (`aes(fill=...)`)\n-   remove the NA group (`filter(!is.na()`)\n-   order the groups from min to max number of studies (`fct_reorder()`)\n-   get rid of x axis' title, text and ticks (`theme(axis...`)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntaxa_barplot<-merge_df %>% \n  group_by(TAXA) %>% \n  summarise(n_studies=n_distinct(id)) %>%\n  ungroup %>%\n  filter(!is.na(TAXA)) %>%\n  mutate(TAXA = fct_reorder(TAXA, n_studies)) %>% \n  ggplot(aes(x=TAXA, y=n_studies, fill = TAXA))+\n  geom_col()+\n  theme(axis.title.x = element_blank(),\n        axis.text.x = element_blank(),\n        axis.ticks.x = element_blank())+\n  labs(x=\"\", y=\"Number of studies\", \n       title = \"Top 4 number of studies per taxa: Terrestrial plants, fish,\\nmarine invertebrates and birds\")\n\ntaxa_barplot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nLet's check the same for climate\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclimate_barplot <- merge_df %>% \n  group_by(CLIMATE) %>% \n  summarise(n_studies=n_distinct(id)) %>%\n  ungroup %>%\n  filter(!is.na(CLIMATE)) %>%\n  mutate(CLIMATE = fct_reorder(CLIMATE, n_studies)) %>% \n  ggplot(aes(x=CLIMATE, y=n_studies, fill = CLIMATE))+\n  geom_col()+\n  theme(axis.title.x = element_blank(),\n        axis.text.x = element_blank(),\n        axis.ticks.x = element_blank())+\n  labs(x=\"\", y=\"Number of studies\", \n       title = \"Most studies come from Temperate climate\")\n\nclimate_barplot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## Boxplots\n\nNow let's filter the top4 taxa, calculate the species richness per study and make a boxplot. Some studies have plots other not. To make things simple, let's consider the overall number of species found each year.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot <- merge_df %>% \n  filter(TAXA %in% c(\"Birds\",\n                     \"Fish\",\n                     \"Terrestrial plants\",\n                     \"Marine invertebrates\")) %>% \n  group_by(id,year) %>% \n  mutate(richness = n_distinct(sp),.after=\"abundance\") %>% \n  ungroup %>% \n  group_by(id) %>% \n  distinct(richness, CLIMATE,year,id,TAXA,PROTECTED_AREA) %>% \n  mutate(n_year = n_distinct(year)) %>%\n         filter(n_year > 10)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>%\n  mutate(TAXA = fct_reorder(TAXA,richness)) %>% \n  ggplot(aes(x=TAXA, y = richness)) +\n  geom_boxplot()+\n  scale_y_log10()+\n  labs(x=\"Taxa\", y=\"Number of species\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\nSometimes we also need to make box plots within groups. For example, let's look at the richness of different taxa in both protected and non-protected areas. Let's use `scale_y_log10()` to make things more comparable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>%\n  mutate(TAXA = fct_reorder(TAXA,richness)) %>% \n  ggplot(aes(x=TAXA, y = richness, fill=PROTECTED_AREA)) +\n  geom_boxplot()+\n  scale_y_log10()+\n  labs(x=\"Taxa\", y=\"Number of species\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\nPreviously, I showed how to reorder groups in our plot. Sometimes we also want to reorder labels manually. We can do that using `fct_relevel()`. Note that as \"Protected_area\" is not a factor, we have to transform it first; here I used `mutate_at()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>%\n  ungroup %>% \n  mutate_at(\"PROTECTED_AREA\", factor) %>% \n  mutate(PROTECTED_AREA = fct_relevel(PROTECTED_AREA,c(\"TRUE\", \"FALSE\"))) %>% \n  ggplot(aes(x=TAXA, y = richness, fill=PROTECTED_AREA)) +\n  geom_boxplot()+\n  scale_y_log10()+\n  labs(x=\"Taxa\", y=\"Number of species\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n## Scatterplots\n\nLet's explore how the number of species is changing over time. First let's check the species richness of fish based on study id (only those with more than 30 years)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>% \n  filter(TAXA == \"Fish\", n_year>30) %>% \n  ggplot(aes(x=year, y = richness, colour = as.factor(id)))+\n  geom_point()\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\nWe can also add a regression line with `geom_smooth()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>% \n  filter(TAXA == \"Fish\", n_year>30) %>% \n  ggplot(aes(x=year, y = richness, colour = as.factor(id)))+\n  geom_point()+\n  geom_smooth(method = \"lm\", se=F)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nWe can also use `interaction` to group variables. Let's try to check the same graph grouping study id and climate.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>% \n  filter(TAXA == \"Fish\", n_year>30) %>% \n  ggplot(aes(x=year, y = richness, colour = interaction(id,CLIMATE)))+\n  geom_point(alpha = .2)+\n  geom_smooth(method = \"lm\", se=F)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\nAs we've seen before, most studies in biotime data set are from temperate climate. Here, it seems that the fish species richness is increasing over time for most studies. *Please note that the idea here is only to show some tools to visualize our data, not deal with fitting model issues :)*\n\n# Nested plots with `facet_wrap()` and `nest`\n\nHere we are exploring only fishes, but we could also plot the same figure for each taxa we have at once. There are two main ways to do so. The first one is with `facet_wrap()`, whereas the second we use `nest()` and `map2()` - nesting our data by taxa, making each figure separately and combining them afterwards. Although `facet_wrap()` is handy for quick graphs when exploring data, most likely, when making more complex graphs, I do prefer the second option because it allows me to modify each figure separately. Let's check both methods.\n\nFirst with `facet_wrap()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrich_plot %>% \n  filter(n_year>30, CLIMATE == \"Temperate\") %>%\n  ggplot(aes(x=year, y = richness, colour = as.factor(id)))+\n  geom_point()+\n  geom_smooth(method = \"lm\", se=F)+\n  scale_y_log10()+\n  facet_wrap(~TAXA)+\n  labs(x=\"Year\", y=\"Species richness\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\nThis one is very simple, you just need to set the function and variable you want to split within panels. Now let's try using `nest()` and `map2()`. With this approach, we first nest our data by taxa and then, as the column is in a list format, we create a new column (*plot*) with `mutate()` and make the plots using `map2()` and `ggplot()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(glue)\n\n\nnested_plots<-rich_plot %>%\n  filter(n_year>30, CLIMATE == \"Temperate\") %>%\n  arrange(desc(year)) %>% \n  group_by(TAXA) %>% \n  nest() %>% \n  mutate(plot = map2(data, TAXA,  ~ggplot(data = .x, aes(x=year, y = richness, colour = as.factor(id)))+\n ggtitle(glue(\"This taxa is: {.y}\"))+\n  geom_point(alpha=.2)+\n  #geom_smooth(method = \"lm\",se=F)))\n  geom_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\",k=5), \n             se=F, size=1.5)+\n    labs(colour=\"Site\")))\n```\n:::\n\n\nHere I also presented a new package `glue` very useful to deal with strings, in this case the title of each plot based on taxa names.\n\nWe could also nest the data by, for example, TAXA and id. In this way we get a separate figure for each study site and TAXA.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnested_plots2 <- rich_plot %>%\n  filter(n_year>30, CLIMATE == \"Temperate\") %>%\n  group_by(id,TAXA) %>% \n  nest() %>% \n  mutate(plot = map2(data, id, ~ggplot(data = .x, aes(x=year, y = richness, colour = CLIMATE))+\n  ggtitle(glue(\"This study site is: n° {.y}\"))+\n  geom_point(alpha=.4)+\n  stat_smooth(method = \"gam\", formula = y ~ s(x, bs = \"cs\"), se=F, size=1.5)))\n\nnested_plots2$plot[[1]]\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\nLet's use the first object though (`nested_plots`). Now it is possible to change each plot separately. For example, let's change the colour pallete of each plot (we can add whatever change we want) and combine them.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfish_fig <- nested_plots$plot[[1]] + scale_colour_brewer(palette = \"Set1\")\n\nbird_fig <- nested_plots$plot[[2]] + scale_colour_brewer(palette = \"Set2\")\n\nplant_fig <- nested_plots$plot[[3]] + scale_colour_brewer(palette = \"Set3\")\n\nmarine_inv_fig <- nested_plots$plot[[4]] + scale_fill_brewer(direction = -1) + theme_dark()\n```\n:::\n\n\n# Combining plots with `cowplot`\n\nTo combine plots we can use different packages. I'm more used to `cowplot` (https://wilkelab.org/cowplot/articles/plot_grid.html) but `patchwork` seems to be a great option as well (https://github.com/thomasp85/patchwork).\n\nIn `cowplot` we have the function `plot_grid()` to combine plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(cowplot)\n\nall_plots <- plot_grid(plant_fig, bird_fig, fish_fig, marine_inv_fig)\nall_plots\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n\n\nFrom this poor exploratory analysis, it seems that the species number variation over time is rather dependent on taxa / study, but I'd guess that we have, overall, more increases than decreases. However, we would have to take into account sampling effort, number of plots, grain size etc, this is not the point of this post though.\n\nLet's understand how `cowplot` works using those bar plots we created at the beginning (taxa and climate ones).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_grid(taxa_barplot, climate_barplot,year_histplot)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\nAs you can see the plots are not aligned. We can correct that with `align`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_grid(taxa_barplot, climate_barplot,year_histplot, align = \"h\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::\n\n\nLet's say we want to put the histogram in the middle of the figure. We can use some tricks in `cowplot` to place the figure where we want. For example, we can set the number of rows and columns that our grid will have with `ncol()` and `nrow()` and control the distance between those grids with `rel_heights()` and `rel_widths()`. So, one way to place the histogram in the middle of the second line, would be:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfirst_line <- plot_grid(taxa_barplot, climate_barplot)\n\nsecond_line <- plot_grid(year_histplot)\n\nplot_grid(first_line, second_line, nrow=2)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\nHistogram is in the second line, but it is too wide. To make it narrow, I usually use empty grids to make this dirty job. We can add two empty grids in both sides and set the `rel_widths()` of each grid, \"squeezing\" the middle panel.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsecond_line <- plot_grid(NULL, year_histplot, NULL, ncol=3, rel_widths = c(.5,1,.5))\n\ncombine_both2 <- plot_grid(first_line, second_line, nrow=2, align = \"hv\")\n```\n:::\n\n\nSometimes we also have to deal with legends. For example, when different panels have a shared legend. Let's duplicate the Taxa plot just to exemplify it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_grid(taxa_barplot, taxa_barplot)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\nLet's keep only one legend using `get_legend()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlegend <- get_legend(taxa_barplot)\n```\n:::\n\n\nCreate the new figure without a legend (`legend.position = \"none\"`)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntaxa_noleg <- taxa_barplot + theme(legend.position = \"none\") # now we create a new object of the figure without a legend\n```\n:::\n\n\nAnd plot both figures and legend\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_grid(taxa_noleg, taxa_noleg, legend)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-30-1.png){width=672}\n:::\n:::\n\n\nWe can play again with `ncol` and `rel_width` to correct the figure\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_grid(taxa_noleg, taxa_noleg, legend, ncol=3, rel_widths = c(.9,.8,.3))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-31-1.png){width=1152}\n:::\n:::\n\n\nA more complex one:\n\n\n::: {.cell}\n\n```{.r .cell-code}\np1 <- plot_grid(taxa_noleg, taxa_noleg,taxa_noleg,ncol=3)\np2 <- plot_grid(NULL, legend, NULL,ncol=3)\np3 <- plot_grid(taxa_noleg, taxa_noleg,taxa_noleg,ncol=3)\n\nplot_grid(p1, p2, p3, nrow=3, rel_heights =c(.8,1,.8)) #note that now I use rel_heights to control the distance between rows.\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\n# Maps with `ggplot`\n\nLast but not least, we can also make maps with `ggplot`. Let's make a map to see how the sites are distributed around the world\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggplot2)\n\n\nbiotime_map <- merge_df %>% \n  filter(!is.na(TAXA)) %>%\n  select(id,year,sp,TAXA,LATITUDE,LONGITUDE) %>% \n  group_by(id) %>% # group by study id\n  mutate(n_sp = n_distinct(sp), # number of species per study\n         n_year = n_distinct(year)) %>% #number of years of sampling \n  select(-sp,-year) %>% #get rid of sp and year columns\n  filter(row_number()==1) # some sites have more than one long and lat, to make it simple, I will filter the first line of each study\n```\n:::\n\n\nIn ggplot we can make an empty object (`ggplot()`) and combine different data frames within the `ggplot()` function. For example, let's create the object `world` to create the world map\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld<- map_data(\"world\")\n\nggplot() +\n  geom_map(\n    data = world, map = world,\n    aes(long, lat, map_id = region),\n    color = \"white\", fill = \"gray50\", size = 0.05, alpha = 0.2\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-34-1.png){width=1152}\n:::\n:::\n\n\nAnd now we can combine the `world` dataframe with our data `biotime_map` to make the map.\n\nA very simple map, to see how the sites are distributed, would be something like this.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_map(\n    data = world, map = world,\n    aes(long, lat, map_id = region),\n    color = \"white\", fill = \"gray50\", size = 0.05, alpha = 0.2\n  ) +\n  geom_point(\n    data = biotime_map,\n    aes(LONGITUDE, LATITUDE),\n    alpha = 0.8\n  ) +\n  theme_void() +\n  labs(x = NULL, y = NULL, color = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-35-1.png){width=1152}\n:::\n:::\n\n\nFrom here, we can add whatever `ggplot` argument and functions we want. For example, let's colour the points based on taxa\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_map(data = world, map = world,\n           aes(long, lat, map_id = region),\n           color = \"white\", fill = \"gray50\", size = 0.05, alpha = 0.2) +\n  geom_point(data = biotime_map, \n             aes(LONGITUDE, LATITUDE, colour=TAXA), size = 3) +\n  theme_void() +\n  labs(x = NULL, y = NULL, color = NULL)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-36-1.png){width=1152}\n:::\n:::\n\n\nOr even to combine many things and make a more complex map.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Just for fun, let's check the top5 sites with longest time series and highest number of species \ntop5_y <- biotime_map %>% \n  arrange(desc(n_year)) %>% \n  head(5) %>% rownames_to_column() %>% \n  mutate(rank_y = glue::glue(\"#{rowname} = {n_year} years - {TAXA}\")) %>% select(id,rank_y)\n\ntop5_sp <- biotime_map %>% \n  arrange(desc(n_sp)) %>% \n  head(5) %>% rownames_to_column() %>% \n  mutate(rank_sp = glue::glue(\"#{rowname} = {n_sp} species - {TAXA}\")) %>% select(id,rank_sp)\n\ntop5_y\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 2\n# Groups:   id [5]\n     id rank_y                              \n  <dbl> <glue>                              \n1   428 #1 = 97 years - Fish                \n2   214 #2 = 88 years - Terrestrial plants  \n3   339 #3 = 57 years - Birds               \n4   298 #4 = 56 years - Terrestrial plants  \n5   147 #5 = 51 years - Marine invertebrates\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntop5_sp\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 5 × 2\n# Groups:   id [5]\n     id rank_sp                                 \n  <dbl> <glue>                                  \n1   162 #1 = 5625 species - Benthos             \n2   187 #2 = 4415 species - Benthos             \n3   110 #3 = 4119 species - Benthos             \n4   186 #4 = 4080 species - Benthos             \n5   129 #5 = 2561 species - Marine invertebrates\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_map(data = world, map = world,\n           aes(long, lat, map_id = region),\n           color = \"white\", fill = \"gray20\", size = 0.05, alpha = 0.2) +\n  \n  geom_point(data = biotime_map, \n             aes(LONGITUDE, LATITUDE, colour=TAXA), size =2) +\n  theme_void() +\n  \n  # Here the idea is to create a label for the top5 sites with the longest time series\n  \n  ggrepel::geom_label_repel(\n    data=(biotime_map %>% \n            filter(id %in% top5_y$id) %>% \n            left_join(top5_y, by = \"id\")), #first I filtered only the top10 sites and combined the \"rank\" column I had in \"top10\" object\n                            size = 3,\n    colour=\"blue\",\n                            box.padding = unit(4, 'lines'), #distance between the labels and points\n                            point.padding = unit(.1, 'lines'), #distance between the \"arrows\" and points\n                            nudge_x = -3,\n                            fill = alpha(c(\"grey\"),0.5), #making the label background transparent\n                            aes(x=LONGITUDE,\n                                y=LATITUDE,\n                                label=as.character(rank_y))\n          )+\n  \n  \n  # We can do the same for labelling the top5 richest sites\n  \n  ggrepel::geom_label_repel(\n    data=(biotime_map %>% \n            filter(id %in% top5_sp$id) %>% \n            left_join(top5_sp, by = \"id\")), \n                            size = 3,\n    colour = \"red\",\n                            box.padding = unit(.8, 'lines'), \n                            point.padding = unit(.1, 'lines'),\n                            nudge_x = -2,\n                            fill = alpha(c(\"grey\"),0.8),\n                            aes(x=LONGITUDE,\n                                y=LATITUDE,\n                                label=as.character(rank_sp))\n          )+\n  labs(x = NULL, y = NULL, color = NULL,\n       title =\"Top 5 sites with the <span style='color:blue;'><strong>longest time series</strong></span> and <span style='color:red;'><strong>highest number of species</strong></span>\")+ # Here is a nice way to have colour in titles using `ggtext`\n  theme(plot.title = element_markdown(lineheight = 1.1))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-39-1.png){width=1152}\n:::\n:::\n\n\nAnyway, sky and common sense (something I didn't have here) are the limit. If you want to learn more `ggplot`, I do recommend to start following some ggplot wizards (e.g. [Thomas Lin Pedersen](https://twitter.com/thomasp85), [Georgios Karamanis](https://twitter.com/geokaramanis) et al.) and the #TidyTuesday community both on [Twitter](https://twitter.com/thomas_mock/) and [GitHub](https://github.com/rfordatascience/tidytuesday).\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}